# План оптимизации RPC запросов

## Цель
Оптимизировать RPC запросы в приложении для снижения затрат на платный пакет Thirdweb RPC и повышения общей производительности.

## Общий подход
1.  Выявить наиболее "тяжелые" хуки/компоненты, генерирующие большое количество RPC запросов.
2.  Рефакторинг выявленных компонентов/хуков для использования батчинга запросов (если доступно через Thirdweb SDK или сторонние библиотеки) и/или более агрессивного кэширования и управления частотой опроса.
3.  Разделение запросов на клиентские и серверные (если применимо), чтобы разгрузить клиент и использовать более дешевые серверные RPC.
4.  Постоянный мониторинг и оценка эффективности внесенных изменений.

## Детальный план (по блокам)

### 1. Блок "Drub" (Drub.tsx, useDrubContract.ts)

1.  [DONE] Настройка инструментов мониторинга RPC (например, вкладка Network в DevTools, логи RPC провайдера).
2.  [DONE] Создание отдельной Git ветки для оптимизации (`feature/rpc-optimization`).
3.  [DONE] Анализ `useDrubContract.ts` для Drub-блока:
    *   Выявлено 9 индивидуальных `useReadContract` запросов, выполняющихся при каждой загрузке компонента.
    *   Большинство запросов не меняются часто.
4.  [DONE] Реализация батчинга RPC запросов для Drub-данных (через `useQueries` из `@tanstack/react-query`):
    *   Импортированы `useQueries` из `@tanstack/react-query` и `useQueryClient`.
    *   Импортированы `type Abi` из `viem` и `type ThirdwebContract` из `thirdweb`.
    *   Внедрена вспомогательная функция `createThirdwebQuery` для типизации объектов запросов `useQueries`.
    *   Заменены 9 индивидуальных `useReadContract` вызовов на один `useQueries` вызов, который выполняет 9 запросов, возвращая результаты в виде массива.
    *   Результаты деструктурированы по оригинальным переменным.
    *   `useQueryClient` инициализирован в хуке.
    *   Вызовы `refetchAll()` в `unifiedBuy`, `addLiquidity`, `burnAllPositions` заменены на `queryClient.invalidateQueries()` для соответствующих контрактов (`drubContract.address`, `hashcoinContract.address`, `nfpmContract.address`).
    *   Функция `refetchAll` удалена из `useDrubContract.ts`.
    *   `refetchAll` удален из деструктуризации и `useEffect` в `src/partials/Drub.tsx`.
    *   `QueryClientProvider` добавлен в `src/main.tsx` для корректной работы React Query.
5.  [DONE] Оптимизация частоты опроса для Drub-данных (через `staleTime`/`refetchInterval`):
    *   К каждому запросу внутри `useQueries` применены `staleTime: 1000 * 60 * 5` (5 минут) и `refetchInterval: 1000 * 60 * 5` (5 минут).
6.  [DONE] Локальное тестирование Drub-блока:
    *   Подтверждена работоспособность приложения.
    *   RPC запросы при первой загрузке сокращены до 3 (для Thirdweb, так как Thirdweb SDK v5 сам батчит `readContract` вызовы в один Multicall запрос, если они делаются в одном цикле рендера/одним вызовом `useQueries`).
    *   Отсутствие ошибок и предупреждений в консоли.
    *   Корректная работа кэширования и фонового обновления.
7.  [DONE] Мониторинг и оценка (Drub):
    *   Подтверждено успешное снижение RPC запросов до 3 при первой загрузке и их эффективное кэширование/обновление.
8.  [TODO] Коммит изменений для Drub-блока.
9.  [TODO] Переход к оптимизации следующего блока: GMNFT.
10. [TODO] Повторение процесса для других блоков.
11. [TODO] Общий мониторинг и финальная оценка.
12. [TODO] Слияние ветки `feature/rpc-optimization` в основную ветку разработки.

### 2. Блок "GMNFT"

... (план будет разработан после завершения Drub-блока)

### 3. Другие блоки

... (план будет разработан после завершения GMNFT-блока)

### 4. Общий мониторинг и финальная оценка

... (после всех оптимизаций)
